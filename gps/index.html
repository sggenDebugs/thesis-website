<!DOCTYPE html>
<html>

<head>
    <title>Bike Tracking System</title>
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
    </style>
</head>

<body>
    <h1>Live Bike Tracking</h1>
    <div id="map"></div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let map;
        let marker;
        let bikeId = 1; // Example: set a default bike ID
        let lastUpdate = 0;

        function initMap() {
            // Initial map setup
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 9.30687095402185, lng: 123.30439309577068 },
                zoom: 15
            });

            const bikeIcon = {
                url: '/img/bike-icon.png', // Custom bike icon
                scaledSize: new google.maps.Size(50, 50),
                origin: new google.maps.Point(0, 0),
                anchor: new google.maps.Point(25, 25)
            };

            marker = new google.maps.Marker({
                position: map.getCenter(),
                map: map,
                icon: bikeIcon,
                title: 'Bike Location'
            });

            // Start updates using jQuery
            startUpdates();
        }

        function updateMarker(lat, lng) {
            const pos = { lat: parseFloat(lat), lng: parseFloat(lng) };
            marker.setPosition(pos);
            map.panTo(pos);
        }

        function startUpdates() {
            const updateInterval = 5000; // 5 seconds

            function checkUpdates() {
                $.ajax({
                    url: '/gps/get_position.php',
                    method: 'GET',
                    data: {
                        bike_id: bikeId,
                        last_update: lastUpdate
                    },
                    success: function (data, textStatus, xhr) {
                        if (xhr.status === 304 || !data) {
                            setTimeout(checkUpdates, updateInterval);
                            return;
                        }

                        updateMarker(data.lat, data.lng);
                        lastUpdate = data.timestamp;

                        setTimeout(checkUpdates, updateInterval);
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.error('AJAX Error:', errorThrown);
                        setTimeout(checkUpdates, updateInterval * 2); // Delay on error
                    }
                });
            }

            checkUpdates();
        }
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCewoqc0dlIGMOb0uHPZE2B_IP05bs2MCc&callback=initMap">
        </script>
</body>

</html>