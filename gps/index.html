<!DOCTYPE html>
<html>

<head>
  <title>Bike Tracking System</title>
  <style>
    #map {
      height: 600px;
      width: 100%;
    }
  </style>
</head>

<body>
  <h1>Live Bike Tracking</h1>
  <div id="map"></div>

  <!-- Include Socket.IO client -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    let marker;
    let map;
    const bikeId = 368; // Your bike ID
    let trailPath;
    let trailCoordinates = [];
    let currentPosition = null;
    let targetPosition = null;
    let animationStartTime = null;
    const animationDuration = 1200;



    function initMap() {
      const bikeIcon = {
        url: '/img/bike-icon.png',
        scaledSize: new google.maps.Size(50, 50),
        origin: new google.maps.Point(0, 0),
        anchor: new google.maps.Point(25, 25)
      };

      // Initialize Google Map
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 9.30687095402185, lng: 123.30439309577068 },
        zoom: 18.5,
        streetViewControl: false
      });

      // Create bike marker
      marker = new google.maps.Marker({
        position: map.getCenter(),
        map: map,
        icon: bikeIcon,
        optimized: false
      });

      // Create the trail polyline
      trailPath = new google.maps.Polyline({
        path: trailCoordinates,
        geodesic: true,
        strokeColor: '#FF0000',
        strokeOpacity: 1.0,
        strokeWeight: 2
      });
      trailPath.setMap(map);

      // Initialize Socket.IO connection with the WebSocket server.
      // Update the URL to match your server configuration.
      const socket = io('ws://147.93.30.102:3000', {
        transports: ['websocket'],
        auth: {
          bikeId: bikeId
        }
      });

      // Register bike on connection
      socket.on('connect', () => {
        console.log('Connected to WebSocket server');
        socket.emit('register-bike', bikeId);
      });

      // Listen for position updates emitted by the server
      socket.on('position', (data) => {
        handleNewPosition(data.lat, data.lng, data.timestamp);
      });

      // Log any connection errors
      socket.on('connect_error', (err) => {
        console.error('Connection error:', err.message);
      });
    }

    function handleNewPosition(lat, lng, timestamp) {
      const newPosition = new google.maps.LatLng(lat, lng);

      // Set initial position or animate transition
      if (!currentPosition) {
        currentPosition = newPosition;
        marker.setPosition(currentPosition);
      } else {
        targetPosition = newPosition;
        animationStartTime = null;
        requestAnimationFrame(animate);
      }

      // Update the trail with the new position
      trailCoordinates.push(newPosition);
      trailPath.setPath(trailCoordinates);
    }

    // Linear interpolation between two positions
    function lerp(start, end, progress) {
      return new google.maps.LatLng(
        start.lat() + (end.lat() - start.lat()) * progress,
        start.lng() + (end.lng() - start.lng()) * progress
      );
    }

    // Animate the marker from current to target position
    function animate(timestamp) {
      if (!currentPosition || !targetPosition) {
        console.warn("Animation skipped: Missing position data");
        return;
      }

      if (!animationStartTime) animationStartTime = timestamp;
      const elapsed = timestamp - animationStartTime;
      const progress = Math.min(elapsed / animationDuration, 1);

      try {
        const intermediatePos = lerp(currentPosition, targetPosition, progress);
        marker.setPosition(intermediatePos);

        // Compute heading for marker rotation using Google Maps geometry library
        const heading = google.maps.geometry.spherical.computeHeading(
          currentPosition,
          targetPosition
        );

        const bikeIcon = {
          url: '/img/bike-icon.png',
          scaledSize: new google.maps.Size(50, 50),
          origin: new google.maps.Point(0, 0),
          anchor: new google.maps.Point(25, 25)
        };
        // Update the marker icon with rotation if needed (note: marker rotation may require custom marker implementation)
        marker.setIcon({ ...bikeIcon, rotation: heading });

        // Optionally pan the map smoothly
        const currentCenter = map.getCenter();
        const newCenter = new google.maps.LatLng(
          currentCenter.lat() + (intermediatePos.lat() - currentCenter.lat()) * 0.1,
          currentCenter.lng() + (intermediatePos.lng() - currentCenter.lng()) * 0.1
        );
        map.panTo(newCenter);
      } catch (error) {
        console.error("Animation error:", error);
        animationStartTime = null;
        return;
      }

      if (progress < 1) {
        requestAnimationFrame(animate);
      } else {
        currentPosition = targetPosition;
        animationStartTime = null;
      }
    }
  </script>

  <!-- Load Google Maps API with geometry library; ensure your API key is valid -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCewoqc0dlIGMOb0uHPZE2B_IP05bs2MCc&libraries=geometry&callback=initMap">
    </script>
</body>

</html>